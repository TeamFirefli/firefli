generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model workspace {
  groupId             Int                        @id @unique
  groupLogo           String?
  groupName           String?
  lastSynced          DateTime?
  ownerId             BigInt?
  batchId             Int?
  adjustments         ActivityAdjustment[]
  activityHistory     ActivityHistory[]
  activityResets      ActivityReset[]
  activitySessions    ActivitySession[]
  allies              Ally[]
  policyLinks         PolicyShareableLink[]
  quotas              Quota[]
  savedViews          SavedView[]
  sessionTypes        SessionType[]
  sessionTags         SessionTag[]
  stickyAnnouncements StickyAnnouncement?
  apiKey              apiKey[]
  config              config[]
  departments         department[]
  documents           document[]
  inactivityNotices   inactivityNotice[]
  ranks               rank[]
  roles               role[]
  userBook            userBook[]
  wallposts           wallPost[]
  externalServices    workspaceExternalServices?
  members             workspaceMember[]
  discordIntegration  DiscordIntegration?
  bloxlinkIntegration BloxlinkIntegration?
}

model config {
  id               Int       @id @default(autoincrement())
  key              String
  value            Json
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  workspaceGroupId Int
  workspace        workspace @relation(fields: [workspaceGroupId], references: [groupId])
}

model instanceConfig {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model user {
  userid                BigInt                 @id @unique
  isOwner               Boolean?
  registered            Boolean?
  picture               String?
  username              String?
  birthdayDay           Int?
  birthdayMonth         Int?
  adjustmentsMade       ActivityAdjustment[]   @relation("AdjustmentActor")
  adjustmentsReceived   ActivityAdjustment[]   @relation("AdjustmentUser")
  activityHistory       ActivityHistory[]
  activityResets        ActivityReset[]
  activitySessions      ActivitySession[]
  policyAcknowledgments PolicyAcknowledgment[]
  createdPolicyLinks    PolicyShareableLink[]
  roleMembers           RoleMember[]
  sessions              Session[]
  sessionLogsAsActor    SessionLog[]           @relation("SessionLogActor")
  sessionLogsAsTarget   SessionLog[]           @relation("SessionLogTarget")
  sessionNotes          SessionNote[]
  allyVisits            allyVisit[]
  apiKey                apiKey[]
  documents             document[]
  inactivityNotices     inactivityNotice[]
  ranks                 rank[]
  sessionsRoles         sessionUser[]
  writtenBooks          userBook[]             @relation("bookAdmin")
  book                  userBook[]             @relation("bookUser")
  info                  userInfo?
  wallPosts             wallPost[]
  managedMembers        workspaceMember[]      @relation("LineManager")
  workspaceMemberships  workspaceMember[]
  Ally                  Ally[]                 @relation("AllyTouser")
  roles                 role[]                 @relation("roleTouser")
  localViews            SavedView[]            @relation("UserLocalViews")

  @@index([birthdayMonth, birthdayDay])
}

model userInfo {
  userid       BigInt  @id
  passwordhash String?
  tfa          String?
  user         user    @relation(fields: [userid], references: [userid])
}

model QuotaRole {
  quotaId String @db.Uuid
  roleId  String @db.Uuid
  quota   Quota  @relation(fields: [quotaId], references: [id])
  role    role   @relation(fields: [roleId], references: [id])

  @@unique([quotaId, roleId])
}

model role {
  id               String        @id @unique @default(uuid()) @db.Uuid
  permissions      String[]
  isOwnerRole      Boolean?      @default(false)
  workspaceGroupId Int
  name             String
  groupRoles       Int[]
  color            String?
  quotaRoles       QuotaRole[]
  roleMembers      RoleMember[]
  workspace        workspace     @relation(fields: [workspaceGroupId], references: [groupId])
  SessionType      SessionType[] @relation("SessionTypeTorole")
  documents        document[]    @relation("documentTorole")
  members          user[]        @relation("roleTouser")
}

model RoleMember {
  roleId        String   @db.Uuid
  userId        BigInt
  manuallyAdded Boolean  @default(false)
  createdAt     DateTime @default(now())
  role          role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user          user     @relation(fields: [userId], references: [userid], onDelete: Cascade)

  @@id([roleId, userId])
}

model department {
  id                String             @id @unique @default(uuid()) @db.Uuid
  name              String
  color             String?
  workspaceGroupId  Int
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  departmentMembers DepartmentMember[]
  quotaDepartments  QuotaDepartment[]
  workspace         workspace          @relation(fields: [workspaceGroupId], references: [groupId])
  SessionType       SessionType[]      @relation("SessionTypeTodepartment")
  documents         document[]         @relation("documentTodepartment")
}

model DepartmentMember {
  departmentId     String          @db.Uuid
  workspaceGroupId Int
  userId           BigInt
  department       department      @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  workspaceMember  workspaceMember @relation(fields: [workspaceGroupId, userId], references: [workspaceGroupId, userId], onDelete: Cascade)

  @@id([departmentId, workspaceGroupId, userId])
}

model QuotaDepartment {
  quotaId      String     @db.Uuid
  departmentId String     @db.Uuid
  department   department @relation(fields: [departmentId], references: [id])
  quota        Quota      @relation(fields: [quotaId], references: [id])

  @@unique([quotaId, departmentId])
}

model wallPost {
  id               Int       @id @default(autoincrement())
  content          String
  image            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  workspaceGroupId Int
  authorId         BigInt
  author           user      @relation(fields: [authorId], references: [userid])
  workspace        workspace @relation(fields: [workspaceGroupId], references: [groupId])

  @@index([workspaceGroupId, createdAt(sort: Desc)])
}

model StickyAnnouncement {
  id               Int       @id @default(autoincrement())
  workspaceGroupId Int       @unique
  title            String
  subtitle         String?
  sections         Json
  editorId         BigInt?
  editorUsername   String?
  editorPicture    String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  workspace        workspace @relation(fields: [workspaceGroupId], references: [groupId])
}

model AuditLog {
  id               Int      @id @default(autoincrement())
  workspaceGroupId Int
  userId           BigInt?
  action           String
  entity           String?
  details          Json?
  createdAt        DateTime @default(now())

  @@index([createdAt])
}

model SessionType {
  id                 String       @id @unique @default(uuid()) @db.Uuid
  name               String
  description        String?
  gameId             BigInt?
  allowUnscheduled   Boolean
  workspaceGroupId   Int
  statues            Json[]
  slots              Json[]
  sessions           Session[]
  workspace          workspace    @relation(fields: [workspaceGroupId], references: [groupId])
  schedule           schedule[]
  hostingDepartments department[] @relation("SessionTypeTodepartment")
  hostingRoles       role[]       @relation("SessionTypeTorole")
  sessionTags        SessionTag[] @relation("SessionTagToSessionType")
}

model SessionTag {
  id               String        @id @unique @default(uuid()) @db.Uuid
  name             String
  color            String
  workspaceGroupId Int
  allowedTypes     String[]
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  sessions         Session[]
  workspace        workspace     @relation(fields: [workspaceGroupId], references: [groupId])
  sessionTypes     SessionType[] @relation("SessionTagToSessionType")

  @@index([workspaceGroupId])
}

model schedule {
  id            String      @id @unique @default(uuid()) @db.Uuid
  Days          Int[]
  Hour          Int
  Minute        Int
  sessionTypeId String      @db.Uuid
  sessions      Session[]
  sessionType   SessionType @relation(fields: [sessionTypeId], references: [id])
}

model sessionUser {
  userid           BigInt
  sessionid        String    @db.Uuid
  roleID           String
  slot             Int
  archiveEndDate   DateTime?
  archiveStartDate DateTime?
  archived         Boolean?  @default(false)
  session          Session   @relation(fields: [sessionid], references: [id])
  user             user      @relation(fields: [userid], references: [userid])

  @@id([userid, sessionid, roleID, slot])
}

model Session {
  id               String        @id @unique @default(uuid()) @db.Uuid
  name             String?
  type             String?
  ownerId          BigInt?
  date             DateTime
  startedAt        DateTime?
  ended            DateTime?
  sessionTypeId    String        @db.Uuid
  scheduleId       String?       @db.Uuid
  sessionTagId     String?       @db.Uuid
  duration         Int           @default(30)
  discordMessageId   String?
  discordChannelId   String?
  lastDiscordStatus  String?
  archiveEndDate   DateTime?
  archiveStartDate DateTime?
  archived         Boolean?      @default(false)
  owner            user?         @relation(fields: [ownerId], references: [userid])
  schedule         schedule?     @relation(fields: [scheduleId], references: [id])
  sessionType      SessionType   @relation(fields: [sessionTypeId], references: [id])
  sessionTag       SessionTag?   @relation(fields: [sessionTagId], references: [id])
  logs             SessionLog[]
  notes            SessionNote[]
  users            sessionUser[]

  @@index([sessionTypeId, date])
}

model SessionNote {
  id        String   @id @unique @default(uuid()) @db.Uuid
  sessionId String   @db.Uuid
  authorId  BigInt
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    user     @relation(fields: [authorId], references: [userid])
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model SessionLog {
  id        String   @id @unique @default(uuid()) @db.Uuid
  sessionId String   @db.Uuid
  actorId   BigInt
  targetId  BigInt?
  action    String
  metadata  Json?
  createdAt DateTime @default(now())
  actor     user     @relation("SessionLogActor", fields: [actorId], references: [userid])
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  target    user?    @relation("SessionLogTarget", fields: [targetId], references: [userid])
}

model ActivitySession {
  id               String    @id @unique @default(uuid()) @db.Uuid
  userId           BigInt
  active           Boolean
  startTime        DateTime
  endTime          DateTime?
  idleTime         BigInt?
  workspaceGroupId Int
  messages         Int?
  universeId       BigInt?
  sessionMessage   String?
  archiveEndDate   DateTime?
  archiveStartDate DateTime?
  archived         Boolean?  @default(false)
  user             user      @relation(fields: [userId], references: [userid])
  workspace        workspace @relation(fields: [workspaceGroupId], references: [groupId])

  @@index([workspaceGroupId, startTime, archived])
  @@index([workspaceGroupId, active, archived])
  @@index([userId, workspaceGroupId])
}

model apiKey {
  id               String    @id @unique
  name             String
  key              String    @unique
  lastUsed         DateTime?
  createdAt        DateTime  @default(now())
  expiresAt        DateTime?
  workspaceGroupId Int
  createdById      BigInt
  createdBy        user      @relation(fields: [createdById], references: [userid])
  workspace        workspace @relation(fields: [workspaceGroupId], references: [groupId])
}

model inactivityNotice {
  id               String    @id @unique @default(uuid()) @db.Uuid
  userId           BigInt
  startTime        DateTime
  endTime          DateTime?
  reason           String
  approved         Boolean?  @default(false)
  reviewed         Boolean?  @default(false)
  revoked          Boolean?  @default(false)
  workspaceGroupId Int
  reviewComment    String?
  user             user      @relation(fields: [userId], references: [userid])
  workspace        workspace @relation(fields: [workspaceGroupId], references: [groupId])

  @@index([workspaceGroupId, endTime, startTime, approved, reviewed])
  @@index([workspaceGroupId, userId])
}

model document {
  id                     String                 @id @unique @default(uuid()) @db.Uuid
  name                   String
  content                Json
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  ownerId                BigInt
  workspaceGroupId       Int
  acknowledgmentDeadline DateTime?
  isTrainingDocument     Boolean                @default(false)
  requiresAcknowledgment Boolean                @default(false)
  acknowledgmentMethod   String?                @default("signature")
  acknowledgmentWord     String?
  assignToEveryone       Boolean                @default(false)
  acknowledgments        PolicyAcknowledgment[]
  shareableLinks         PolicyShareableLink[]
  owner                  user                   @relation(fields: [ownerId], references: [userid])
  workspace              workspace              @relation(fields: [workspaceGroupId], references: [groupId])
  departments            department[]           @relation("documentTodepartment")
  roles                  role[]                 @relation("documentTorole")

  @@index([workspaceGroupId, isTrainingDocument])
}

model userBook {
  id               String    @id @unique @default(uuid()) @db.Uuid
  userId           BigInt
  type             String
  reason           String
  adminId          BigInt
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  workspaceGroupId Int
  rankAfter        Int?
  rankBefore       Int?
  rankNameAfter    String?
  rankNameBefore   String?
  redacted         Boolean?  @default(false)
  redactedAt       DateTime?
  redactedBy       BigInt?
  admin            user      @relation("bookAdmin", fields: [adminId], references: [userid])
  user             user      @relation("bookUser", fields: [userId], references: [userid])
  workspace        workspace @relation(fields: [workspaceGroupId], references: [groupId])
}

model rank {
  userId           BigInt
  rankId           BigInt
  workspaceGroupId Int
  user             user      @relation(fields: [userId], references: [userid], onDelete: Cascade)
  workspace        workspace @relation(fields: [workspaceGroupId], references: [groupId], onDelete: Cascade)

  @@id([userId, workspaceGroupId])
}

model Quota {
  id               String            @id @default(uuid()) @db.Uuid
  type             String
  value            Int
  workspaceGroupId Int
  name             String
  description      String?
  sessionType      String?
  workspace        workspace         @relation(fields: [workspaceGroupId], references: [groupId])
  quotaDepartments QuotaDepartment[]
  quotaRoles       QuotaRole[]
}

model Ally {
  workspaceGroupId Int
  name             String
  icon             String
  groupId          String
  notes            String[]
  id               String      @id @unique @default(uuid()) @db.Uuid
  discordServer    String?
  theirReps        String[]
  workspace        workspace   @relation(fields: [workspaceGroupId], references: [groupId])
  allyVisits       allyVisit[]
  reps             user[]      @relation("AllyTouser")
}

model allyVisit {
  id           String   @id @unique @default(uuid()) @db.Uuid
  allyId       String   @db.Uuid
  hostId       BigInt
  time         DateTime
  name         String
  participants BigInt[]
  ally         Ally     @relation(fields: [allyId], references: [id])
  host         user     @relation(fields: [hostId], references: [userid])
}

model workspaceMember {
  workspaceGroupId     Int
  userId               BigInt
  joinDate             DateTime?
  birthdayDay          Int?
  birthdayMonth        Int?
  discordId            String?
  isAdmin              Boolean?           @default(false)
  lineManagerId        BigInt?
  timezone             String?
  introMessage         String?
  trackId              String?
  trackName            String?
  artistName           String?
  artwork              String?
  previewUrl           String?
  departmentMembers    DepartmentMember[]
  lineManager          user?              @relation("LineManager", fields: [lineManagerId], references: [userid], onDelete: NoAction, onUpdate: NoAction)
  user                 user               @relation(fields: [userId], references: [userid])
  workspace            workspace          @relation(fields: [workspaceGroupId], references: [groupId])

  @@id([workspaceGroupId, userId])
  @@index([userId])
  @@index([lineManagerId])
  @@index([workspaceGroupId, joinDate])
}

model ActivityAdjustment {
  id               String    @id @default(uuid()) @db.Uuid
  userId           BigInt
  actorId          BigInt
  workspaceGroupId Int
  minutes          Int
  reason           String?
  createdAt        DateTime  @default(now())
  archiveEndDate   DateTime?
  archiveStartDate DateTime?
  archived         Boolean?  @default(false)
  actor            user      @relation("AdjustmentActor", fields: [actorId], references: [userid])
  user             user      @relation("AdjustmentUser", fields: [userId], references: [userid])
  workspace        workspace @relation(fields: [workspaceGroupId], references: [groupId])

  @@index([userId])
  @@index([actorId])
  @@index([workspaceGroupId])
  @@index([workspaceGroupId, createdAt, archived])
}

model ActivityHistory {
  id               String    @id @default(uuid()) @db.Uuid
  userId           BigInt
  workspaceGroupId Int
  periodStart      DateTime
  periodEnd        DateTime
  minutes          Int
  messages         Int
  sessionsHosted   Int
  sessionsAttended Int
  idleTime         Int
  wallPosts        Int       @default(0)
  quotaProgress    Json
  createdAt        DateTime  @default(now())
  user             user      @relation(fields: [userId], references: [userid])
  workspace        workspace @relation(fields: [workspaceGroupId], references: [groupId])

  @@index([userId])
  @@index([workspaceGroupId])
  @@index([periodStart])
  @@index([periodEnd])
}

model ActivityReset {
  id                  String    @id @default(uuid()) @db.Uuid
  workspaceGroupId    Int
  resetById           BigInt?
  resetAt             DateTime  @default(now())
  previousPeriodStart DateTime?
  previousPeriodEnd   DateTime?
  resetBy             user?     @relation(fields: [resetById], references: [userid])
  workspace           workspace @relation(fields: [workspaceGroupId], references: [groupId])

  @@index([workspaceGroupId])
  @@index([resetAt])
}

model workspaceExternalServices {
  id                 Int       @id @default(autoincrement())
  workspaceGroupId   Int       @unique
  rankingProvider    String?
  rankingToken       String?
  rankingWorkspaceId String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  workspace          workspace @relation(fields: [workspaceGroupId], references: [groupId])

  @@index([workspaceGroupId])
}

model SavedView {
  id               String    @id @default(uuid()) @db.Uuid
  workspaceGroupId Int
  name             String
  color            String?
  icon             String?
  filters          Json
  columnVisibility Json
  isLocal          Boolean   @default(false)
  createdBy        BigInt?
  createdAt        DateTime  @default(now())
  order            Int       @default(0)
  workspace        workspace @relation(fields: [workspaceGroupId], references: [groupId])
  creator          user?     @relation("UserLocalViews", fields: [createdBy], references: [userid])

  @@index([workspaceGroupId])
  @@index([createdBy])
  @@index([workspaceGroupId, isLocal, order])
}

model PolicyAcknowledgment {
  id             String   @id @default(uuid()) @db.Uuid
  userId         BigInt
  documentId     String   @db.Uuid
  acknowledgedAt DateTime @default(now())
  ipAddress      String?
  signature      String?
  isRequired     Boolean  @default(false)
  document       document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user           user     @relation(fields: [userId], references: [userid])

  @@unique([userId, documentId])
  @@index([userId])
  @@index([documentId])
}

model PolicyShareableLink {
  id               String    @id @default(uuid()) @db.Uuid
  documentId       String    @db.Uuid
  workspaceGroupId Int
  name             String
  description      String?
  createdById      BigInt
  createdAt        DateTime  @default(now())
  expiresAt        DateTime?
  isActive         Boolean   @default(true)
  accessCount      Int       @default(0)
  lastAccessed     DateTime?
  createdBy        user      @relation(fields: [createdById], references: [userid])
  document         document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  workspace        workspace @relation(fields: [workspaceGroupId], references: [groupId])

  @@index([documentId])
  @@index([workspaceGroupId])
  @@index([createdById])
}

model DiscordIntegration {
  id               String    @id @default(uuid()) @db.Uuid
  workspaceGroupId Int       @unique
  botToken         String
  guildId          String
  guildName        String?
  channelId        String
  channelName      String?
  birthdayChannelId String?
  birthdayChannelName String?
  enabledEvents    Json      @default("[]")
  birthdayEnabled  Boolean   @default(false)

  embedTitle       String?
  embedColor       String?
  embedFooter      String?
  embedThumbnail   Boolean   @default(true)

  promotionEmbedTitle       String?
  promotionEmbedColor       String?
  promotionEmbedDescription String?
  promotionEmbedFooter      String?

  demotionEmbedTitle        String?
  demotionEmbedColor        String?
  demotionEmbedDescription  String?
  demotionEmbedFooter       String?

  warningEmbedTitle         String?
  warningEmbedColor         String?
  warningEmbedDescription   String?
  warningEmbedFooter        String?

  terminationEmbedTitle     String?
  terminationEmbedColor     String?
  terminationEmbedDescription String?
  terminationEmbedFooter    String?

  noticeSubmitEmbedTitle    String?
  noticeSubmitEmbedColor    String?
  noticeSubmitEmbedDescription String?
  noticeSubmitEmbedFooter   String?
  noticeApprovalEmbedTitle  String?
  noticeApprovalEmbedColor  String?
  noticeApprovalEmbedDescription String?
  noticeApprovalEmbedFooter String?
  noticeDenialEmbedTitle    String?
  noticeDenialEmbedColor    String?
  noticeDenialEmbedDescription String?
  noticeDenialEmbedFooter   String?

  birthdayEmbedTitle        String?
  birthdayEmbedColor        String?
  birthdayEmbedDescription  String?

  sessionChannelId          String?
  sessionChannelName        String?
  sessionNotifyOnCreate     Boolean   @default(false)
  sessionNotifyOnClaim      Boolean   @default(false)
  sessionNotifyOnStart      Boolean   @default(false)
  sessionEmbedTitle         String?
  sessionEmbedColor         String?
  sessionEmbedDescription   String?
  sessionEmbedFooter        String?
  sessionPingRoleId         String?
  sessionPingRoleName       String?
  pingRoles                 Json?

  isActive         Boolean   @default(true)
  lastMessageAt    DateTime?
  errorCount       Int       @default(0)
  lastError        String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  workspace        workspace @relation(fields: [workspaceGroupId], references: [groupId], onDelete: Cascade)

  @@index([workspaceGroupId])
  @@index([guildId])
  @@index([channelId])
}

model BloxlinkIntegration {
  id                 String    @id @default(uuid()) @db.Uuid
  workspaceGroupId   Int       @unique
  apiKey             String
  discordServerId    String
  isActive           Boolean   @default(true)
  notifyPromotion    Boolean   @default(true)
  notifyDemotion     Boolean   @default(true)
  notifyWarning      Boolean   @default(true)
  messageTemplate    Json?
  lastUsed           DateTime?
  errorCount         Int       @default(0)
  lastError          String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  workspace          workspace @relation(fields: [workspaceGroupId], references: [groupId], onDelete: Cascade)

  @@index([workspaceGroupId])
  @@index([discordServerId])
}
